<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Nutrient Analyzer - AI Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }

    .header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .content {
        padding: 30px;
    }

    .upload-section {
        text-align: center;
        padding: 40px 20px;
        border: 3px dashed #ddd;
        border-radius: 15px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-section:hover {
        border-color: #2ecc71;
        background: #e8f5e9;
    }

    .upload-section.dragover {
        border-color: #27ae60;
        background: #c8e6c9;
    }

    .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .upload-section h2 {
        color: #333;
        margin-bottom: 10px;
    }

    .upload-section p {
        color: #666;
        font-size: 14px;
    }

    input[type="file"] {
        display: none;
    }

    .preview-section {
        display: none;
        margin-top: 30px;
    }

    .preview-section.active {
        display: block;
    }

    .image-preview {
        width: 100%;
        max-width: 500px;
        margin: 0 auto 20px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .image-preview img {
        width: 100%;
        height: auto;
        display: block;
    }

    .analysis-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 15px 30px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 200px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .results-section {
        display: none;
        margin-top: 20px;
    }

    .results-section.active {
        display: block;
    }

    .analysis-type-label {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .label-color {
        background: #e3f2fd;
        color: #1976d2;
    }

    .label-ai {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .deficiency-card {
        background: #fff;
        border-left: 4px solid #e74c3c;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .deficiency-card.low {
        border-left-color: #f39c12;
    }

    .deficiency-card.none {
        border-left-color: #2ecc71;
    }

    .deficiency-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .deficiency-name {
        font-size: 20px;
        font-weight: 600;
        color: #333;
    }

    .confidence-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        background: #e74c3c;
        color: white;
    }

    .confidence-badge.medium {
        background: #f39c12;
    }

    .confidence-badge.low {
        background: #95a5a6;
    }

    .deficiency-description {
        color: #555;
        line-height: 1.6;
        margin-bottom: 15px;
    }

    .treatment-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-top: 10px;
    }

    .treatment-section h4 {
        color: #2ecc71;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .treatment-section ul {
        margin-left: 20px;
        color: #555;
    }

    .treatment-section li {
        margin-bottom: 5px;
    }

    .ai-results {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        white-space: pre-wrap;
        line-height: 1.6;
        color: #333;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 40px;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2ecc71;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-message {
        background: #fee;
        border: 1px solid #fcc;
        color: #c33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
    }

    .error-message.active {
        display: block;
    }

    .api-key-section {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .api-key-section h3 {
        color: #856404;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .api-key-section input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        margin-top: 10px;
    }

    .api-key-section p {
        color: #856404;
        font-size: 13px;
        margin-top: 10px;
        line-height: 1.5;
    }

    .api-key-section a {
        color: #856404;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .analysis-buttons {
            flex-direction: column;
        }
        
        .btn {
            min-width: 100%;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŒ± Plant Nutrient Analyzer</h1>
            <p>AI-Enhanced Edition - Color Analysis + Claude Vision</p>
        </div>

```
    <div class="content">
        <!-- API Key Section -->
        <div class="api-key-section">
            <h3>ðŸ”‘ Anthropic API Key (for AI Analysis)</h3>
            <input type="password" id="apiKey" placeholder="sk-ant-...">
            <p>To use AI-powered analysis, enter your Anthropic API key. Get one at <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>. Your key is stored locally in your browser and never sent anywhere except directly to Anthropic's API.</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">ðŸ“¸</div>
            <h2>Upload Plant Photo</h2>
            <p>Click anywhere here to select an image, or drag and drop</p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="margin-top: 15px;">
                Choose Image File
            </button>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="previewSection">
            <div class="image-preview">
                <img id="previewImage" alt="Plant preview">
            </div>

            <div class="analysis-buttons">
                <button class="btn btn-primary" id="analyzeColorBtn">
                    ðŸŽ¨ Color Analysis
                </button>
                <button class="btn btn-secondary" id="analyzeAIBtn">
                    ðŸ¤– AI Analysis
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your plant...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection"></div>
        </div>
    </div>
</div>

<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        
    // DOM Elements
    const uploadSection = document.getElementById('uploadSection');
    const fileInput = document.getElementById('fileInput');
    const previewSection = document.getElementById('previewSection');
    const previewImage = document.getElementById('previewImage');
    const analyzeColorBtn = document.getElementById('analyzeColorBtn');
    const analyzeAIBtn = document.getElementById('analyzeAIBtn');
    const resultsSection = document.getElementById('resultsSection');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('errorMessage');
    const apiKeyInput = document.getElementById('apiKey');

    let currentImageData = null;
    
    console.log('Elements found:', {
        uploadSection: !!uploadSection,
        fileInput: !!fileInput,
        previewSection: !!previewSection
    });

    // Load API key from localStorage
    const savedApiKey = localStorage.getItem('anthropicApiKey');
    if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
    }

    // Save API key when changed
    apiKeyInput.addEventListener('change', () => {
        localStorage.setItem('anthropicApiKey', apiKeyInput.value);
    });

    // Upload Section Click
    uploadSection.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and Drop
    uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.classList.add('dragover');
    });

    uploadSection.addEventListener('dragleave', () => {
        uploadSection.classList.remove('dragover');
    });

    uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            handleImage(file);
        }
    });

    // File Input Change
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleImage(file);
        }
    });

    // Handle Image Upload
    function handleImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImageData = e.target.result;
            previewImage.src = currentImageData;
            previewSection.classList.add('active');
            resultsSection.classList.remove('active');
            errorMessage.classList.remove('active');
        };
        reader.readAsDataURL(file);
    }

    // Color Analysis Button
    analyzeColorBtn.addEventListener('click', () => {
        performColorAnalysis();
    });

    // AI Analysis Button
    analyzeAIBtn.addEventListener('click', () => {
        performAIAnalysis();
    });

    // Color-based Analysis (Your original logic)
    function performColorAnalysis() {
        showLoading();
        
        // Create a canvas to analyze the image
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Resize for faster processing
            const maxSize = 500;
            let width = img.width;
            let height = img.height;
            
            if (width > height && width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
            } else if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // Get image data
            const imageData = ctx.getImageData(0, 0, width, height);
            const pixels = imageData.data;
            
            // Analyze colors
            const results = analyzePixels(pixels);
            
            hideLoading();
            displayColorResults(results);
        };
        img.src = currentImageData;
    }

    function analyzePixels(pixels) {
        let totalPixels = 0;
        let yellowPixels = 0;
        let greenPixels = 0;
        let darkGreenPixels = 0;
        let purplePixels = 0;
        let brownPixels = 0;
        
        for (let i = 0; i < pixels.length; i += 4) {
            const r = pixels[i];
            const g = pixels[i + 1];
            const b = pixels[i + 2];
            
            // Skip very dark or very bright pixels (likely background/highlights)
            const brightness = (r + g + b) / 3;
            if (brightness < 30 || brightness > 240) continue;
            
            totalPixels++;
            
            // Color classification
            const h = rgbToHue(r, g, b);
            const s = rgbToSaturation(r, g, b);
            
            // Yellow (nitrogen deficiency indicator)
            if (h >= 40 && h <= 70 && s > 0.3 && g > r * 0.9 && g > b) {
                yellowPixels++;
            }
            
            // Green (healthy)
            if (h >= 80 && h <= 160 && s > 0.2) {
                greenPixels++;
                if (brightness < 120) {
                    darkGreenPixels++;
                }
            }
            
            // Purple/Red (phosphorus deficiency)
            if ((h < 20 || h > 300) && s > 0.2) {
                purplePixels++;
            }
            
            // Brown (potassium deficiency)
            if (h >= 15 && h <= 45 && s < 0.5 && brightness < 150) {
                brownPixels++;
            }
        }
        
        // Calculate percentages
        const yellowPercent = (yellowPixels / totalPixels) * 100;
        const greenPercent = (greenPixels / totalPixels) * 100;
        const purplePercent = (purplePixels / totalPixels) * 100;
        const brownPercent = (brownPixels / totalPixels) * 100;
        
        // Detect deficiencies
        const deficiencies = [];
        
        // Nitrogen (yellowing)
        if (yellowPercent > 15 || (greenPercent > 0 && darkGreenPixels / greenPixels < 0.3)) {
            deficiencies.push({
                name: 'Nitrogen',
                confidence: yellowPercent > 25 ? 'High' : yellowPercent > 15 ? 'Medium' : 'Low',
                severity: yellowPercent > 25 ? 'high' : 'medium',
                description: 'Yellowing of leaves, especially older leaves, indicates nitrogen deficiency. Plants appear pale green to yellow.',
                treatments: [
                    'Apply nitrogen-rich fertilizer (high first number in N-P-K ratio)',
                    'Use blood meal, fish emulsion, or composted manure',
                    'For quick results, use water-soluble nitrogen fertilizer',
                    'Add compost to improve soil nitrogen content'
                ]
            });
        }
        
        // Phosphorus (purple/red)
        if (purplePercent > 10) {
            deficiencies.push({
                name: 'Phosphorus',
                confidence: purplePercent > 20 ? 'High' : purplePercent > 10 ? 'Medium' : 'Low',
                severity: purplePercent > 20 ? 'high' : 'medium',
                description: 'Purple or reddish discoloration, especially on older leaves and stems, suggests phosphorus deficiency.',
                treatments: [
                    'Apply bone meal or rock phosphate',
                    'Use fertilizer with high middle number (phosphorus) in N-P-K ratio',
                    'Ensure soil pH is between 6.0-7.0 for optimal phosphorus uptake',
                    'Add compost to improve phosphorus availability'
                ]
            });
        }
        
        // Potassium (brown edges)
        if (brownPercent > 12) {
            deficiencies.push({
                name: 'Potassium',
                confidence: brownPercent > 20 ? 'High' : brownPercent > 12 ? 'Medium' : 'Low',
                severity: brownPercent > 20 ? 'high' : 'medium',
                description: 'Brown, scorched leaf edges and tips indicate potassium deficiency. Older leaves affected first.',
                treatments: [
                    'Apply potassium sulfate or potassium chloride',
                    'Use wood ash (but monitor soil pH)',
                    'Apply fertilizer with high last number (potassium) in N-P-K ratio',
                    'Use kelp meal or greensand for organic option'
                ]
            });
        }
        
        if (deficiencies.length === 0) {
            deficiencies.push({
                name: 'No Major Deficiencies Detected',
                confidence: 'Assessment',
                severity: 'none',
                description: 'Based on color analysis, your plant appears healthy with good green coloration. Continue current care routine.',
                treatments: [
                    'Maintain current fertilization schedule',
                    'Monitor plant regularly for changes',
                    'Ensure proper watering and light conditions',
                    'Consider soil testing for detailed nutrient analysis'
                ]
            });
        }
        
        return deficiencies;
    }

    function rgbToHue(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        const delta = max - min;
        
        if (delta === 0) return 0;
        
        let hue;
        if (max === r) {
            hue = ((g - b) / delta) % 6;
        } else if (max === g) {
            hue = (b - r) / delta + 2;
        } else {
            hue = (r - g) / delta + 4;
        }
        
        hue = Math.round(hue * 60);
        if (hue < 0) hue += 360;
        
        return hue;
    }

    function rgbToSaturation(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        
        if (max === 0) return 0;
        
        return (max - min) / max;
    }

    function displayColorResults(deficiencies) {
        let html = '<span class="analysis-type-label label-color">Color-Based Analysis</span>';
        
        deficiencies.forEach(def => {
            html += `
                <div class="deficiency-card ${def.severity}">
                    <div class="deficiency-header">
                        <div class="deficiency-name">${def.name}</div>
                        <div class="confidence-badge ${def.confidence.toLowerCase()}">${def.confidence} Confidence</div>
                    </div>
                    <div class="deficiency-description">${def.description}</div>
                    <div class="treatment-section">
                        <h4>ðŸ’Š Recommended Treatments:</h4>
                        <ul>
                            ${def.treatments.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        });
        
        resultsSection.innerHTML = html;
        resultsSection.classList.add('active');
    }

    // AI Analysis
    async function performAIAnalysis() {
        const apiKey = apiKeyInput.value.trim();
        
        if (!apiKey) {
            showError('Please enter your Anthropic API key to use AI analysis.');
            return;
        }
        
        showLoading();
        errorMessage.classList.remove('active');
        
        try {
            // Convert image to base64 (remove data URL prefix)
            const base64Image = currentImageData.split(',')[1];
            const mediaType = currentImageData.split(';')[0].split(':')[1];
            
            console.log('Media type:', mediaType);
            console.log('Image data length:', base64Image.length);
            console.log('Sending request to Anthropic API...');
            
            const requestBody = {
                model: 'claude-sonnet-4-20250514',
                max_tokens: 2000,
                messages: [{
                    role: 'user',
                    content: [
                        {
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: mediaType,
                                data: base64Image
                            }
                        },
                        {
                            type: 'text',
                            text: `Analyze this plant photo for nutrient deficiencies and health issues. Provide:
```

1. Overall health assessment
1. Specific nutrient deficiencies detected (nitrogen, phosphorus, potassium, iron, magnesium, etc.)
1. Confidence level for each deficiency
1. Visible symptoms youâ€™re observing
1. Recommended treatments and corrections

Format your response clearly with sections and be specific about what you see in the image.`
}
]
}]
};

```
            console.log('Request body structure:', JSON.stringify({
                model: requestBody.model,
                max_tokens: requestBody.max_tokens,
                messageCount: requestBody.messages.length,
                contentTypes: requestBody.messages[0].content.map(c => c.type)
            }));
            
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify(requestBody)
            }).catch(fetchError => {
                console.error('Fetch failed:', fetchError);
                throw new Error(`Network request failed: ${fetchError.message}`);
            });
            
            console.log('Response received successfully');
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            console.log('Response type:', response.type);
            console.log('Response headers:', [...response.headers.entries()]);
            
            // Get the response text first for debugging
            let responseText;
            try {
                responseText = await response.text();
                console.log('Response text retrieved, length:', responseText.length);
                console.log('Response text (first 1000 chars):', responseText.substring(0, 1000));
                console.log('Response text (last 200 chars):', responseText.substring(Math.max(0, responseText.length - 200)));
            } catch (textError) {
                console.error('Failed to get response text:', textError);
                throw new Error(`Failed to read response: ${textError.message}`);
            }
            
            if (!response.ok) {
                let errorMsg = `API error: ${response.status}`;
                try {
                    const errorData = JSON.parse(responseText);
                    console.log('Error data:', errorData);
                    errorMsg = errorData.error?.message || errorData.message || errorMsg;
                    
                    // More helpful error messages
                    if (response.status === 401) {
                        errorMsg = 'Invalid API key. Please check your key at console.anthropic.com';
                    } else if (response.status === 403) {
                        errorMsg = 'Access forbidden. Check your API key permissions.';
                    } else if (response.status === 429) {
                        errorMsg = 'Rate limit exceeded. Please wait and try again.';
                    }
                } catch (e) {
                    console.error('Failed to parse error:', e);
                    errorMsg += ` - ${responseText.substring(0, 200)}`;
                }
                throw new Error(errorMsg);
            }
            
            // Parse the response
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error('JSON parse error:', e);
                console.error('Response was:', responseText);
                throw new Error(`Failed to parse API response as JSON. Response: ${responseText.substring(0, 200)}`);
            }
            
            console.log('Parsed data structure:', {
                hasContent: !!data.content,
                contentIsArray: Array.isArray(data.content),
                contentLength: data.content?.length,
                contentTypes: data.content?.map(c => c.type)
            });
            
            // Check if response has expected structure
            if (!data.content) {
                throw new Error(`Response missing 'content' field. Got: ${JSON.stringify(Object.keys(data))}`);
            }
            
            if (!Array.isArray(data.content)) {
                throw new Error(`'content' is not an array. Got type: ${typeof data.content}`);
            }
            
            if (data.content.length === 0) {
                throw new Error('Response content array is empty');
            }
            
            // Get the text from the response
            let analysisText = '';
            for (const item of data.content) {
                console.log('Content item type:', item.type);
                if (item.type === 'text') {
                    analysisText += item.text;
                }
            }
            
            if (!analysisText) {
                console.error('Full response data:', data);
                throw new Error(`No text content found. Content types: ${data.content.map(c => c.type).join(', ')}`);
            }
            
            console.log('Analysis text length:', analysisText.length);
            
            hideLoading();
            displayAIResults(analysisText);
            
        } catch (error) {
            console.error('Full error object:', error);
            console.error('Error name:', error.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            hideLoading();
            
            let userMessage = error.message;
            
            // Check for common issues
            if (error.message.includes('fetch')) {
                userMessage = 'Network error. Check your internet connection and try again.';
            } else if (error.message.includes('CORS')) {
                userMessage = 'Browser security error (CORS). Try using a different browser or check browser console for details.';
            }
            
            showError(`AI Analysis failed: ${userMessage}\n\nCheck browser console (F12) for detailed logs.`);
        }
    }

    function displayAIResults(text) {
        const html = `
            <span class="analysis-type-label label-ai">AI-Powered Analysis</span>
            <div class="ai-results">${text}</div>
        `;
        
        resultsSection.innerHTML = html;
        resultsSection.classList.add('active');
    }

    function showLoading() {
        loading.classList.add('active');
        analyzeColorBtn.disabled = true;
        analyzeAIBtn.disabled = true;
    }

    function hideLoading() {
        loading.classList.remove('active');
        analyzeColorBtn.disabled = false;
        analyzeAIBtn.disabled = false;
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('active');
    }
    
    }); // End of DOMContentLoaded
</script>
```

</body>
</html>
